{% extends "base.html" %}

{% block content %}
<!-- Article IDs embedded for JS navigation -->
<script id="article-data" type="application/json">{{ article_ids | tojson }}</script>

<!-- Hero strip -->
<div class="xybitz-hero mb-4">
  <div class="hero-left">
    <span class="hero-live"><span class="live-dot-sm"></span> LIVE</span>
    <span class="hero-tagline">AI-summarised cybersec intel. 100 words. Zero noise.</span>
  </div>
  <div class="hero-right">
    <span class="hero-count">{{ total_today }}<span class="hero-count-label">today</span></span>
    <span class="hero-keys"><span class="key-badge">&#8592;</span> <span class="key-badge">&#8594;</span></span>
  </div>
</div>

<!-- Category filter pills — hidden on mobile -->
<div class="d-flex gap-2 flex-wrap mb-4 justify-content-center cat-pill-row">
  <a href="/"
     class="cat-pill {% if current_category == 'all' %}active{% endif %}"
     style="--pill-color:#6610f2">
    All
  </a>
  {% for cat in categories %}
  <a href="/?category={{ cat.slug }}"
     class="cat-pill {% if current_category == cat.slug %}active{% endif %}"
     style="--pill-color:#{{ cat.color | cat_hex }}">
    {{ cat.name }}
  </a>
  {% endfor %}
</div>

<!-- Mobile compact filter bar — hidden on desktop -->
<div class="mobile-filter-bar">
  <span class="mobile-active-cat">
    <span style="width:8px;height:8px;border-radius:50%;background:
      {%- if current_category == 'all' %}#6610f2
      {%- else %}{% for cat in categories %}{% if cat.slug == current_category %}#{{ cat.color | cat_hex }}{% endif %}{% endfor %}
      {%- endif %};display:inline-block;flex-shrink:0"></span>
    {%- if current_category == 'all' %}All Categories
    {%- else %}{% for cat in categories %}{% if cat.slug == current_category %}{{ cat.name }}{% endif %}{% endfor %}
    {%- endif %}
  </span>
  <button class="mobile-filter-btn" onclick="openFilterSheet()" aria-label="Filter by category">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="10" y1="18" x2="14" y2="18"/></svg>
    Filter
  </button>
</div>

<!-- Swipe UI -->
{% if article_ids %}
<div class="swipe-ui">

  <!-- Navigation + card + navigation -->
  <div class="swipe-row">
    <button class="nav-arrow" id="prev-btn" onclick="navigate(-1)" aria-label="Previous article" disabled>
      &#8592;
    </button>

    <div id="card-zone">
      {% if article %}
        {% include "partials/tinder_card.html" %}
      {% endif %}
    </div>

    <button class="nav-arrow" id="next-btn" onclick="navigate(1)" aria-label="Next article">
      &#8594;
    </button>
  </div>

  <!-- Progress indicator -->
  <div class="swipe-progress text-center mt-3">
    <span id="progress-label" style="color:var(--text-muted)" class="small">1 of {{ article_ids | length }}</span>
    <div class="swipe-progress-bar mt-2">
      <div class="swipe-progress-fill" id="progress-fill" style="width: {% if article_ids %}{{ (1 / article_ids|length * 100) | round(1) }}{% else %}0{% endif %}%"></div>
    </div>
  </div>

</div>
{% else %}
<div class="text-center py-5">
  <p style="color:var(--text-muted)" class="fs-5">No articles yet. Check back soon.</p>
  <small style="color:var(--text-muted)">RSS feeds refresh every 30 minutes</small>
</div>
{% endif %}

<script>
(function() {
  const ids = JSON.parse(document.getElementById('article-data').textContent || '[]');
  let idx = 0;
  const total = ids.length;

  const cardZone  = document.getElementById('card-zone');
  const prevBtn   = document.getElementById('prev-btn');
  const nextBtn   = document.getElementById('next-btn');
  const progLabel = document.getElementById('progress-label');
  const progFill  = document.getElementById('progress-fill');

  function updateNav() {
    if (!prevBtn || !nextBtn) return;
    prevBtn.disabled = idx === 0;
    nextBtn.disabled = idx === total - 1;
    if (progLabel) progLabel.textContent = `${idx + 1} of ${total}`;
    if (progFill && total > 0) progFill.style.width = ((idx + 1) / total * 100).toFixed(1) + '%';
  }

  async function loadCard(direction) {
    if (idx < 0 || idx >= total) return;

    // Animate out
    cardZone.classList.add('card-exit-' + (direction > 0 ? 'left' : 'right'));

    try {
      const resp = await fetch(`/articles/card/${ids[idx]}`);
      if (!resp.ok) throw new Error(resp.status);
      const html = await resp.text();

      await new Promise(r => setTimeout(r, 150));
      cardZone.innerHTML = html;
      cardZone.classList.remove('card-exit-left', 'card-exit-right');
      cardZone.classList.add('card-enter');
      setTimeout(() => cardZone.classList.remove('card-enter'), 300);
      // Show "...read more" button only if summary text is actually clamped
      const p = cardZone.querySelector('.tinder-summary-collapsed');
      const rm = cardZone.querySelector('.read-more-btn');
      if (p && rm && p.scrollHeight > p.clientHeight + 2) rm.style.display = 'block';
    } catch(e) {
      cardZone.classList.remove('card-exit-left', 'card-exit-right');
    }

    updateNav();
  }

  window.navigate = function(dir) {
    const next = idx + dir;
    if (next < 0 || next >= total) return;
    idx = next;
    loadCard(dir);
  };

  // Keyboard arrow navigation
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft')  window.navigate(-1);
    if (e.key === 'ArrowRight') window.navigate(1);
  });

  // Touch/swipe support
  let touchStartX = 0;
  cardZone && cardZone.addEventListener('touchstart', function(e) {
    touchStartX = e.touches[0].clientX;
  }, { passive: true });
  cardZone && cardZone.addEventListener('touchend', function(e) {
    const diff = touchStartX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) window.navigate(diff > 0 ? 1 : -1);
  }, { passive: true });

  // Init
  updateNav();

  // Show "...read more" on the initial server-rendered card if needed
  const initP = cardZone && cardZone.querySelector('.tinder-summary-collapsed');
  const initRm = cardZone && cardZone.querySelector('.read-more-btn');
  if (initP && initRm && initP.scrollHeight > initP.clientHeight + 2) initRm.style.display = 'block';
})();
</script>
<!-- Mobile category filter bottom sheet -->
<div class="filter-sheet-overlay" id="filter-overlay" onclick="closeFilterSheet()"></div>
<div class="filter-sheet" id="filter-sheet" role="dialog" aria-modal="true" aria-label="Filter by category">
  <div class="filter-sheet-handle"></div>
  <div class="filter-sheet-title">Filter by Category</div>
  <a href="/" class="filter-sheet-item {% if current_category == 'all' %}active{% endif %}">
    <span class="filter-sheet-dot" style="background:#6610f2"></span>
    All Categories
    {% if current_category == 'all' %}<span style="margin-left:auto;font-size:.7rem;color:#a78bfa">✓</span>{% endif %}
  </a>
  {% for cat in categories %}
  <a href="/?category={{ cat.slug }}"
     class="filter-sheet-item {% if current_category == cat.slug %}active{% endif %}">
    <span class="filter-sheet-dot" style="background:#{{ cat.color | cat_hex }}"></span>
    {{ cat.name }}
    {% if current_category == cat.slug %}<span style="margin-left:auto;font-size:.7rem;color:#a78bfa">✓</span>{% endif %}
  </a>
  {% endfor %}
</div>

<script>
function openFilterSheet() {
  document.getElementById('filter-sheet').classList.add('open');
  document.getElementById('filter-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeFilterSheet() {
  document.getElementById('filter-sheet').classList.remove('open');
  document.getElementById('filter-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeFilterSheet();
});
function toggleReadMore(id) {
  var p = document.getElementById('ts-' + id);
  var btn = document.getElementById('rm-' + id);
  if (!p) return;
  if (p.classList.contains('expanded')) {
    p.classList.remove('expanded');
    btn.textContent = '\u2026read more';
  } else {
    p.classList.add('expanded');
    btn.textContent = 'less \u2191';
  }
}
</script>
{% endblock %}
